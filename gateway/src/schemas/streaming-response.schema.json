{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://ekai.ai/schemas/canonical-streaming-response/v1.0.0",
  "title": "Canonical AI Streaming Response Schema",
  "description": "Universal schema for AI provider streaming responses - superset of all streaming capabilities",
  
  "definitions": {
    "streamingChoice": {
      "type": "object",
      "properties": {
        "index": { "type": "integer", "minimum": 0 },
        "delta": {
          "type": "object",
          "properties": {
            "role": { "type": "string" },
            "content": { "type": "string" },
            "tool_calls": {
              "type": "array",
              "items": {
                "type": "object",
                "properties": {
                  "id": { "type": "string" },
                  "index": { "type": "integer", "minimum": 0 },
                  "type": { "const": "function" },
                  "function": {
                    "type": "object",
                    "properties": {
                      "name": { "type": "string" },
                      "arguments": { "type": "string" }
                    },
                    "additionalProperties": false
                  }
                },
                "additionalProperties": false
              }
            },
            "function_call": {
              "type": "object",
              "properties": {
                "name": { "type": "string" },
                "arguments": { "type": "string" }
              },
              "additionalProperties": false
            }
          },
          "additionalProperties": false
        },
        "logprobs": {
          "type": "object",
          "properties": {
            "content": {
              "type": "array",
              "items": {
                "type": "object",
                "properties": {
                  "token": { "type": "string" },
                  "logprob": { "type": "number" },
                  "bytes": {
                    "type": "array",
                    "items": { "type": "integer" }
                  },
                  "top_logprobs": {
                    "type": "array",
                    "items": {
                      "type": "object",
                      "properties": {
                        "token": { "type": "string" },
                        "logprob": { "type": "number" },
                        "bytes": {
                          "type": "array",
                          "items": { "type": "integer" }
                        }
                      },
                      "required": ["token", "logprob"],
                      "additionalProperties": false
                    }
                  }
                },
                "required": ["token", "logprob"],
                "additionalProperties": false
              }
            }
          },
          "additionalProperties": false
        },
        "finish_reason": {
          "enum": [
            "stop", "length", "tool_calls", "content_filter", 
            "function_call", "end_turn", "max_tokens", 
            "stop_sequence", "tool_use", "error", null
          ]
        }
      },
      "required": ["index"],
      "additionalProperties": false
    },
    
    "anthropicEvent": {
      "oneOf": [
        {
          "type": "object",
          "properties": {
            "type": { "const": "message_start" },
            "message": {
              "type": "object",
              "properties": {
                "id": { "type": "string" },
                "type": { "const": "message" },
                "role": { "const": "assistant" },
                "content": { "type": "array" },
                "model": { "type": "string" },
                "stop_reason": { "type": "null" },
                "stop_sequence": { "type": "null" },
                "usage": {
                  "type": "object",
                  "properties": {
                    "input_tokens": { "type": "integer", "minimum": 0 },
                    "output_tokens": { "type": "integer", "minimum": 0 }
                  },
                  "required": ["input_tokens", "output_tokens"],
                  "additionalProperties": false
                }
              },
              "required": ["id", "type", "role", "content", "model", "stop_reason", "stop_sequence", "usage"],
              "additionalProperties": false
            }
          },
          "required": ["type", "message"],
          "additionalProperties": false
        },
        {
          "type": "object",
          "properties": {
            "type": { "const": "content_block_start" },
            "index": { "type": "integer", "minimum": 0 },
            "content_block": {
              "oneOf": [
                {
                  "type": "object",
                  "properties": {
                    "type": { "const": "text" },
                    "text": { "type": "string" }
                  },
                  "required": ["type", "text"],
                  "additionalProperties": false
                },
                {
                  "type": "object",
                  "properties": {
                    "type": { "const": "tool_use" },
                    "id": { "type": "string" },
                    "name": { "type": "string" },
                    "input": { "type": "object" }
                  },
                  "required": ["type", "id", "name", "input"],
                  "additionalProperties": false
                }
              ]
            }
          },
          "required": ["type", "index", "content_block"],
          "additionalProperties": false
        },
        {
          "type": "object",
          "properties": {
            "type": { "const": "content_block_delta" },
            "index": { "type": "integer", "minimum": 0 },
            "delta": {
              "oneOf": [
                {
                  "type": "object",
                  "properties": {
                    "type": { "const": "text_delta" },
                    "text": { "type": "string" }
                  },
                  "required": ["type", "text"],
                  "additionalProperties": false
                },
                {
                  "type": "object",
                  "properties": {
                    "type": { "const": "input_json_delta" },
                    "partial_json": { "type": "string" }
                  },
                  "required": ["type", "partial_json"],
                  "additionalProperties": false
                },
                {
                  "type": "object",
                  "properties": {
                    "type": { "const": "citations_delta" },
                    "citations": {
                      "type": "array",
                      "items": {
                        "type": "object",
                        "additionalProperties": true
                      }
                    }
                  },
                  "required": ["type", "citations"],
                  "additionalProperties": false
                }
              ]
            }
          },
          "required": ["type", "index", "delta"],
          "additionalProperties": false
        },
        {
          "type": "object",
          "properties": {
            "type": { "const": "content_block_stop" },
            "index": { "type": "integer", "minimum": 0 }
          },
          "required": ["type", "index"],
          "additionalProperties": false
        },
        {
          "type": "object",
          "properties": {
            "type": { "const": "message_delta" },
            "delta": {
              "type": "object",
              "properties": {
                "stop_reason": {
                  "enum": ["end_turn", "max_tokens", "stop_sequence", "tool_use"]
                },
                "stop_sequence": { "type": "string" }
              },
              "additionalProperties": false
            },
            "usage": {
              "type": "object",
              "properties": {
                "output_tokens": { "type": "integer", "minimum": 0 }
              },
              "required": ["output_tokens"],
              "additionalProperties": false
            }
          },
          "required": ["type", "delta", "usage"],
          "additionalProperties": false
        },
        {
          "type": "object",
          "properties": {
            "type": { "const": "message_stop" }
          },
          "required": ["type"],
          "additionalProperties": false
        },
        {
          "type": "object",
          "properties": {
            "type": { "const": "ping" }
          },
          "required": ["type"],
          "additionalProperties": false
        }
      ]
    }
  },
  
  "oneOf": [
    {
      "type": "object",
      "properties": {
        "schema_version": { "const": "1.0.1" },
        "stream_type": { "const": "canonical" },
        "event": {
          "oneOf": [
            {
              "type": "object",
              "properties": {
                "type": { "const": "message_start" },
                "id": { "type": "string" },
                "model": { "type": "string" }
              },
              "required": ["type"],
              "additionalProperties": false
            },
            {
              "type": "object",
              "properties": {
                "type": { "const": "content_delta" },
                "part": { "enum": ["text", "tool_call", "thinking"] },
                "value": { "type": "string" }
              },
              "required": ["type", "part", "value"],
              "additionalProperties": false
            },
            {
              "type": "object",
              "properties": {
                "type": { "const": "tool_call" },
                "name": { "type": "string" },
                "arguments_json": { "type": "string" },
                "id": { "type": "string" }
              },
              "required": ["type", "name", "arguments_json"],
              "additionalProperties": false
            },
            {
              "type": "object",
              "properties": {
                "type": { "const": "usage" },
                "input_tokens": { "type": "integer" },
                "output_tokens": { "type": "integer" },
                "prompt_tokens": { "type": "integer" },
                "completion_tokens": { "type": "integer" }
              },
              "required": ["type"],
              "additionalProperties": false
            },
            {
              "type": "object",
              "properties": {
                "type": { "const": "complete" },
                "finish_reason": {
                  "enum": ["stop", "length", "tool_call", "content_filter", "safety", "unknown"]
                }
              },
              "required": ["type", "finish_reason"],
              "additionalProperties": false
            },
            {
              "type": "object",
              "properties": {
                "type": { "const": "error" },
                "code": { "type": "string" },
                "message": { "type": "string" }
              },
              "required": ["type", "message"],
              "additionalProperties": false
            }
          ]
        },
        "provider_raw": {
          "type": "object",
          "additionalProperties": true
        }
      },
      "required": ["schema_version", "stream_type", "event"],
      "additionalProperties": false
    },
    {
      "type": "object",
      "properties": {
        "schema_version": { "const": "1.0.1" },
        "stream_type": { "const": "openai" },
        "id": { "type": "string", "minLength": 1 },
        "object": { "const": "chat.completion.chunk" },
        "created": { "type": "integer", "minimum": 0 },
        "model": { "type": "string", "minLength": 1 },
        "system_fingerprint": { "type": "string" },
        "choices": {
          "type": "array",
          "items": { "$ref": "#/definitions/streamingChoice" },
          "minItems": 1
        },
        "usage": {
          "type": "object",
          "properties": {
            "prompt_tokens": { "type": "integer", "minimum": 0 },
            "completion_tokens": { "type": "integer", "minimum": 0 },
            "total_tokens": { "type": "integer", "minimum": 0 }
          },
          "additionalProperties": false
        }
      },
      "required": ["schema_version", "stream_type", "id", "object", "created", "model", "choices"],
      "additionalProperties": false
    },
    {
      "type": "object",
      "properties": {
        "schema_version": { "const": "1.0.1" },
        "stream_type": { "const": "anthropic" },
        "event": { "$ref": "#/definitions/anthropicEvent" }
      },
      "required": ["schema_version", "stream_type", "event"],
      "additionalProperties": false
    }
  ]
}