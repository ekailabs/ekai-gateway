{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://ekailabs.xyz/schemas/canonical-request/v1.0.0",
  "title": "Canonical AI Request Schema",
  "description": "Universal schema for AI provider requests, superset of all input capabilities",
  
  "definitions": {
    "inputContent": {
      "oneOf": [
        { "$ref": "#/definitions/textInput" },
        { "$ref": "#/definitions/imageInput" },
        { "$ref": "#/definitions/audioInput" },
        { "$ref": "#/definitions/videoInput" },
        { "$ref": "#/definitions/documentInput" },
        { "$ref": "#/definitions/toolResultInput" }
      ]
    },
    
    "textInput": {
      "type": "object",
      "properties": {
        "type": { "const": "text" },
        "text": { 
          "type": "string",
          "minLength": 1,
          "maxLength": 1000000
        }
      },
      "required": ["type", "text"],
      "additionalProperties": false
    },
    
    "imageInput": {
      "type": "object",
      "properties": {
        "type": { "const": "image" },
        "source": {
          "oneOf": [
            {
              "type": "object",
              "properties": {
                "type": { "const": "base64" },
                "media_type": {
                  "enum": ["image/jpeg", "image/png", "image/gif", "image/webp"]
                },
                "data": {
                  "type": "string",
                  "pattern": "^[A-Za-z0-9+/]*={0,2}$"
                }
              },
              "required": ["type", "media_type", "data"],
              "additionalProperties": false
            },
            {
              "type": "object",
              "properties": {
                "type": { "const": "url" },
                "url": { "type": "string", "format": "uri" }
              },
              "required": ["type", "url"],
              "additionalProperties": false
            }
          ]
        }
      },
      "required": ["type", "source"],
      "additionalProperties": false
    },
    
    "audioInput": {
      "type": "object",
      "properties": {
        "type": { "const": "audio" },
        "source": {
          "oneOf": [
            {
              "type": "object",
              "properties": {
                "type": { "const": "base64" },
                "media_type": {
                  "enum": ["audio/wav", "audio/mp3", "audio/aac", "audio/ogg", "audio/flac"]
                },
                "data": {
                  "type": "string",
                  "pattern": "^[A-Za-z0-9+/]*={0,2}$"
                }
              },
              "required": ["type", "media_type", "data"],
              "additionalProperties": false
            },
            {
              "type": "object",
              "properties": {
                "type": { "const": "url" },
                "url": { "type": "string", "format": "uri" }
              },
              "required": ["type", "url"],
              "additionalProperties": false
            }
          ]
        }
      },
      "required": ["type", "source"],
      "additionalProperties": false
    },
    
    "videoInput": {
      "type": "object",
      "properties": {
        "type": { "const": "video" },
        "source": {
          "oneOf": [
            {
              "type": "object",
              "properties": {
                "type": { "const": "base64" },
                "media_type": {
                  "enum": ["video/mp4", "video/mpeg", "video/quicktime", "video/webm"]
                },
                "data": {
                  "type": "string",
                  "pattern": "^[A-Za-z0-9+/]*={0,2}$"
                }
              },
              "required": ["type", "media_type", "data"],
              "additionalProperties": false
            },
            {
              "type": "object",
              "properties": {
                "type": { "const": "url" },
                "url": { "type": "string", "format": "uri" }
              },
              "required": ["type", "url"],
              "additionalProperties": false
            }
          ]
        }
      },
      "required": ["type", "source"],
      "additionalProperties": false
    },
    
    "documentInput": {
      "type": "object",
      "properties": {
        "type": { "const": "document" },
        "source": {
          "oneOf": [
            {
              "type": "object",
              "properties": {
                "type": { "const": "base64" },
                "media_type": {
                  "enum": ["application/pdf", "text/plain", "text/html", "text/markdown"]
                },
                "data": {
                  "type": "string",
                  "pattern": "^[A-Za-z0-9+/]*={0,2}$"
                }
              },
              "required": ["type", "media_type", "data"],
              "additionalProperties": false
            },
            {
              "type": "object",
              "properties": {
                "type": { "const": "url" },
                "url": { "type": "string", "format": "uri" }
              },
              "required": ["type", "url"],
              "additionalProperties": false
            }
          ]
        }
      },
      "required": ["type", "source"],
      "additionalProperties": false
    },
    
    "toolResultInput": {
      "type": "object",
      "properties": {
        "type": { "const": "tool_result" },
        "tool_use_id": { "type": "string", "minLength": 1 },
        "content": {
          "oneOf": [
            { "type": "string" },
            {
              "type": "array",
              "items": { "$ref": "#/definitions/inputContent" }
            }
          ]
        },
        "is_error": { "type": "boolean" }
      },
      "required": ["type", "tool_use_id", "content"],
      "additionalProperties": false
    },
    
    "message": {
      "type": "object",
      "properties": {
        "role": {
          "enum": ["user", "assistant", "tool"]
        },
        "content": {
          "oneOf": [
            { "type": "string" },
            {
              "type": "array",
              "items": { "$ref": "#/definitions/inputContent" },
              "minItems": 1
            }
          ]
        },
        "name": { "type": "string" },
        "tool_call_id": { "type": "string" },
        "tool_calls": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "id": { "type": "string" },
              "type": { "const": "function" },
              "function": {
                "type": "object",
                "properties": {
                  "name": { "type": "string" },
                  "arguments": { "type": "string" }
                },
                "required": ["name", "arguments"],
                "additionalProperties": false
              }
            },
            "required": ["id", "type", "function"],
            "additionalProperties": false
          }
        }
      },
      "required": ["role", "content"],
      "additionalProperties": false
    },
    
    "tool": {
      "type": "object",
      "properties": {
        "type": { "const": "function" },
        "function": {
          "type": "object",
          "properties": {
            "name": {
              "type": "string",
              "pattern": "^[a-zA-Z0-9_-]+$"
            },
            "description": { "type": "string" },
            "parameters": {
              "type": "object",
              "additionalProperties": true
            },
            "strict": { "type": "boolean" }
          },
          "required": ["name"],
          "additionalProperties": false
        }
      },
      "required": ["type", "function"],
      "additionalProperties": false
    },
    
    "toolChoice": {
      "oneOf": [
        { "enum": ["auto", "none", "any", "required"] },
        {
          "type": "object",
          "properties": {
            "type": { "const": "function" },
            "function": {
              "type": "object",
              "properties": {
                "name": { "type": "string" }
              },
              "required": ["name"],
              "additionalProperties": false
            },
            "allow_parallel": { "type": "boolean" }
          },
          "required": ["type", "function"],
          "additionalProperties": false
        },
        {
          "type": "object",
          "properties": {
            "type": { "const": "tool" },
            "name": { "type": "string" },
            "allow_parallel": { "type": "boolean" }
          },
          "required": ["type", "name"],
          "additionalProperties": false
        }
      ]
    },
    
    "safetySettings": {
      "type": "object",
      "properties": {
        "category": {
          "enum": [
            "HARM_CATEGORY_HARASSMENT",
            "HARM_CATEGORY_HATE_SPEECH",
            "HARM_CATEGORY_SEXUALLY_EXPLICIT", 
            "HARM_CATEGORY_DANGEROUS_CONTENT",
            "HARM_CATEGORY_UNSPECIFIED"
          ]
        },
        "threshold": {
          "enum": [
            "BLOCK_NONE",
            "BLOCK_ONLY_HIGH",
            "BLOCK_MEDIUM_AND_ABOVE", 
            "BLOCK_LOW_AND_ABOVE"
          ]
        }
      },
      "required": ["category", "threshold"],
      "additionalProperties": false
    },
    
    "responseFormat": {
      "oneOf": [
        { "enum": ["text", "json", "json_object"] },
        {
          "type": "object",
          "properties": {
            "type": { "const": "json_schema" },
            "json_schema": {
              "type": "object",
              "properties": {
                "name": { "type": "string" },
                "description": { "type": "string" },
                "schema": {
                  "type": "object",
                  "additionalProperties": true
                },
                "strict": { "type": "boolean" }
              },
              "required": ["name", "schema"],
              "additionalProperties": false
            }
          },
          "required": ["type", "json_schema"],
          "additionalProperties": false
        }
      ]
    }
  },
  
  "type": "object",
  "properties": {
    "schema_version": { "const": "1.0.1" },
    "model": {
      "type": "string",
      "minLength": 1
    },
    "messages": {
      "type": "array",
      "items": { "$ref": "#/definitions/message" },
      "minItems": 1
    },
    "system": {
      "oneOf": [
        { "type": "string" },
        {
          "type": "array",
          "items": { "$ref": "#/definitions/inputContent" }
        }
      ]
    },
    "generation": {
      "type": "object",
      "properties": {
        "max_tokens": {
          "type": "integer",
          "minimum": 1,
          "maximum": 1000000
        },
        "temperature": {
          "type": "number",
          "minimum": 0,
          "maximum": 2
        },
        "top_p": {
          "type": "number",
          "minimum": 0,
          "maximum": 1
        },
        "top_k": {
          "type": "integer",
          "minimum": 1,
          "maximum": 100
        },
        "stop": {
          "oneOf": [
            { "type": "string" },
            {
              "type": "array",
              "items": { "type": "string" },
              "maxItems": 64
            }
          ]
        },
        "seed": {
          "type": "integer",
          "minimum": 0
        },
        "frequency_penalty": {
          "type": "number",
          "minimum": -2,
          "maximum": 2
        },
        "presence_penalty": {
          "type": "number",
          "minimum": -2,
          "maximum": 2
        },
        "n": {
          "type": "integer",
          "minimum": 1,
          "maximum": 20
        },
        "logprobs": { "type": "boolean" },
        "top_logprobs": {
          "type": "integer",
          "minimum": 0,
          "maximum": 5
        },
        "logit_bias": {
          "type": "object",
          "patternProperties": {
            "^\\d+$": {
              "type": "number",
              "minimum": -100,
              "maximum": 100
            }
          },
          "additionalProperties": false
        },
        "stop_sequences": {
          "type": "array",
          "items": { "type": "string" },
          "maxItems": 64
        }
      },
      "additionalProperties": false
    },
    "tools": {
      "type": "array",
      "items": { "$ref": "#/definitions/tool" }
    },
    "tool_choice": { "$ref": "#/definitions/toolChoice" },
    "parallel_tool_calls": { "type": "boolean" },
    "functions": {
      "type": "array",
      "items": {
        "type": "object",
        "properties": {
          "name": {
            "type": "string",
            "pattern": "^[a-zA-Z0-9_-]+$"
          },
          "description": { "type": "string" },
          "parameters": {
            "type": "object",
            "additionalProperties": true
          }
        },
        "required": ["name"],
        "additionalProperties": false
      }
    },
    "function_call": {
      "oneOf": [
        { "enum": ["auto", "none"] },
        {
          "type": "object",
          "properties": {
            "name": { "type": "string" }
          },
          "required": ["name"],
          "additionalProperties": false
        }
      ]
    },
    "response_format": { "$ref": "#/definitions/responseFormat" },
    "safety_settings": {
      "type": "array",
      "items": { "$ref": "#/definitions/safetySettings" }
    },
    "candidate_count": {
      "type": "integer",
      "minimum": 1,
      "maximum": 8
    },
    "stream": { "type": "boolean" },
    "stream_options": {
      "type": "object",
      "properties": {
        "include_usage": { "type": "boolean" }
      },
      "additionalProperties": false
    },
    "service_tier": {
      "enum": ["auto", "default", "scale", "flex", "priority", null]
    },
    "reasoning_effort": {
      "enum": ["low", "medium", "high"]
    },
    "modalities": {
      "type": "array",
      "items": {
        "enum": ["text", "audio"]
      },
      "uniqueItems": true
    },
    "audio": {
      "type": "object",
      "properties": {
        "voice": {
          "enum": ["alloy", "echo", "fable", "onyx", "nova", "shimmer"]
        },
        "format": {
          "enum": ["wav", "mp3", "flac", "aac", "opus", "pcm16"]
        }
      },
      "additionalProperties": false
    },
    "prediction": {
      "type": "object",
      "properties": {
        "type": {
          "enum": ["content"]
        },
        "content": {
          "oneOf": [
            { "type": "string" },
            {
              "type": "array",
              "items": { "$ref": "#/definitions/inputContent" }
            }
          ]
        }
      },
      "required": ["type", "content"],
      "additionalProperties": false
    },
    "tier": {
      "enum": ["priority", "standard"]
    },
    "thinking": {
      "type": "object",
      "properties": {
        "enabled": { "type": "boolean" },
        "budget": {
          "type": "integer",
          "minimum": 1024
        }
      },
      "additionalProperties": false
    },
    "betas": {
      "type": "array",
      "items": { "type": "string" }
    },
    "extra_headers": {
      "type": "object",
      "additionalProperties": { "type": "string" }
    },
    "timeout": {
      "type": "number",
      "minimum": 0
    },
    "user": { "type": "string" },
    "context": {
      "type": "object",
      "properties": {
        "previous_response_id": { "type": "string" },
        "cache_ref": { "type": "string" },
        "provider_state": {
          "type": "object",
          "additionalProperties": true
        }
      },
      "additionalProperties": false
    },
    "attachments": {
      "type": "array",
      "items": {
        "type": "object",
        "properties": {
          "id": { "type": "string" },
          "name": { "type": "string" },
          "content_type": { "type": "string" },
          "size": { "type": "integer", "minimum": 0 },
          "url": { "type": "string", "format": "uri" }
        },
        "required": ["id", "name"],
        "additionalProperties": false
      }
    },
    "provider_params": {
      "type": "object",
      "properties": {
        "openai": { "type": "object", "additionalProperties": true },
        "anthropic": { "type": "object", "additionalProperties": true },
        "gemini": { "type": "object", "additionalProperties": true }
      },
      "additionalProperties": false
    },
    "meta": {
      "type": "object",
      "properties": {
        "user_id": { "type": "string" },
        "session_id": { "type": "string" },
        "tags": {
          "type": "array",
          "items": { "type": "string" }
        }
      },
      "additionalProperties": true
    }
  },
  "required": ["schema_version", "model", "messages"],
  "additionalProperties": false
}