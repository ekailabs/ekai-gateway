{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://ekailabs.xyz/schemas/canonical-response/v1.0.0",
  "title": "Canonical AI Response Schema",
  "description": "Universal schema for AI provider responses - superset of all output capabilities",
  
  "definitions": {
    "outputContent": {
      "oneOf": [
        { "$ref": "#/definitions/textOutput" },
        { "$ref": "#/definitions/thinkingOutput" },
        { "$ref": "#/definitions/toolUseOutput" },
        { "$ref": "#/definitions/codeExecutionOutput" },
        { "$ref": "#/definitions/webSearchOutput" },
        { "$ref": "#/definitions/citationOutput" }
      ]
    },
    
    "textOutput": {
      "type": "object",
      "properties": {
        "type": { "const": "text" },
        "text": { "type": "string" },
        "annotations": {
          "type": "object",
          "properties": {
            "citations": {
              "type": "array",
              "items": { "$ref": "#/definitions/citation" }
            }
          },
          "additionalProperties": false
        }
      },
      "required": ["type", "text"],
      "additionalProperties": false
    },
    
    "thinkingOutput": {
      "type": "object",
      "properties": {
        "type": { "const": "thinking" },
        "thinking": { "type": "string" }
      },
      "required": ["type", "thinking"],
      "additionalProperties": false
    },
    
    "toolUseOutput": {
      "type": "object",
      "properties": {
        "type": { "const": "tool_use" },
        "id": { "type": "string", "minLength": 1 },
        "name": { "type": "string", "pattern": "^[a-zA-Z0-9_-]+$" },
        "input": {
          "oneOf": [
            { "type": "object", "additionalProperties": true },
            { "type": "string" },
            { "type": "array", "items": {} },
            { "type": "null" }
          ]
        }
      },
      "required": ["type", "id", "name", "input"],
      "additionalProperties": false
    },
    
    "codeExecutionOutput": {
      "type": "object",
      "properties": {
        "type": { "const": "code_execution" },
        "language": { "type": "string" },
        "code": { "type": "string" },
        "output": { "type": "string" },
        "error": { "type": "string" },
        "execution_time": { "type": "number", "minimum": 0 }
      },
      "required": ["type", "language", "code"],
      "additionalProperties": false
    },
    
    "webSearchOutput": {
      "type": "object",
      "properties": {
        "type": { "const": "web_search" },
        "query": { "type": "string" },
        "results": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "url": { "type": "string", "format": "uri" },
              "title": { "type": "string" },
              "snippet": { "type": "string" },
              "relevance_score": { "type": "number", "minimum": 0, "maximum": 1 }
            },
            "required": ["url", "title"],
            "additionalProperties": false
          }
        }
      },
      "required": ["type", "query", "results"],
      "additionalProperties": false
    },
    
    "citationOutput": {
      "type": "object",
      "properties": {
        "type": { "const": "citation" },
        "sources": {
          "type": "array",
          "items": { "$ref": "#/definitions/citation" }
        }
      },
      "required": ["type", "sources"],
      "additionalProperties": false
    },
    
    "citation": {
      "type": "object",
      "properties": {
        "url": { "type": "string", "format": "uri" },
        "title": { "type": "string" },
        "start_index": { "type": "integer", "minimum": 0 },
        "end_index": { "type": "integer", "minimum": 0 },
        "confidence": { "type": "number", "minimum": 0, "maximum": 1 }
      },
      "required": ["url"],
      "additionalProperties": false
    },
    
    "message": {
      "type": "object",
      "properties": {
        "role": { "const": "assistant" },
        "content": {
          "type": "array",
          "items": { "$ref": "#/definitions/outputContent" },
          "minItems": 1
        }
      },
      "required": ["role", "content"],
      "additionalProperties": false
    },
    
    "choice": {
      "type": "object",
      "properties": {
        "index": { "type": "integer", "minimum": 0 },
        "message": { "$ref": "#/definitions/message" },
        "finish_reason": {
          "enum": [
            "stop", "length", "tool_calls", "content_filter", 
            "function_call", "end_turn", "max_tokens", 
            "stop_sequence", "tool_use", "error", "recitation", "safety"
          ]
        },
        "tool_calls": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "id": { "type": "string" },
              "type": { "const": "function" },
              "function": {
                "type": "object",
                "properties": {
                  "name": { "type": "string" },
                  "arguments": { "type": "string" }
                },
                "required": ["name", "arguments"],
                "additionalProperties": false
              }
            },
            "required": ["id", "type", "function"],
            "additionalProperties": false
          }
        },
        "logprobs": {
          "type": "object",
          "properties": {
            "content": {
              "type": "array",
              "items": {
                "type": "object",
                "properties": {
                  "token": { "type": "string" },
                  "logprob": { "type": "number" },
                  "bytes": {
                    "type": "array",
                    "items": { "type": "integer" }
                  },
                  "top_logprobs": {
                    "type": "array",
                    "items": {
                      "type": "object",
                      "properties": {
                        "token": { "type": "string" },
                        "logprob": { "type": "number" },
                        "bytes": {
                          "type": "array",
                          "items": { "type": "integer" }
                        }
                      },
                      "required": ["token", "logprob"],
                      "additionalProperties": false
                    }
                  }
                },
                "required": ["token", "logprob"],
                "additionalProperties": false
              }
            }
          },
          "additionalProperties": false
        },
        "safety_ratings": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "category": {
                "enum": [
                  "HARM_CATEGORY_HARASSMENT",
                  "HARM_CATEGORY_HATE_SPEECH",
                  "HARM_CATEGORY_SEXUALLY_EXPLICIT",
                  "HARM_CATEGORY_DANGEROUS_CONTENT"
                ]
              },
              "probability": {
                "enum": ["NEGLIGIBLE", "LOW", "MEDIUM", "HIGH"]
              },
              "blocked": { "type": "boolean" }
            },
            "required": ["category", "probability"],
            "additionalProperties": false
          }
        }
      },
      "required": ["index", "message"],
      "additionalProperties": false
    },
    
    "usage": {
      "type": "object",
      "properties": {
        "prompt_tokens": { "type": "integer", "minimum": 0 },
        "completion_tokens": { "type": "integer", "minimum": 0 },
        "total_tokens": { "type": "integer", "minimum": 0 },
        "input_tokens": { "type": "integer", "minimum": 0 },
        "output_tokens": { "type": "integer", "minimum": 0 },
        "cached_tokens": { "type": "integer", "minimum": 0 },
        "reasoning_tokens": { "type": "integer", "minimum": 0 },
        "completion_tokens_details": {
          "type": "object",
          "properties": {
            "reasoning_tokens": { "type": "integer", "minimum": 0 },
            "audio_tokens": { "type": "integer", "minimum": 0 },
            "accepted_prediction_tokens": { "type": "integer", "minimum": 0 },
            "rejected_prediction_tokens": { "type": "integer", "minimum": 0 }
          },
          "additionalProperties": false
        },
        "predictions": {
          "type": "object",
          "properties": {
            "accepted_tokens": { "type": "integer", "minimum": 0 },
            "rejected_tokens": { "type": "integer", "minimum": 0 }
          },
          "additionalProperties": false
        },
        "provider_breakdown": {
          "type": "object",
          "additionalProperties": {
            "type": ["number", "integer", "string", "object", "null"]
          }
        },
        "prompt_tokens_details": {
          "type": "object",
          "properties": {
            "cached_tokens": { "type": "integer", "minimum": 0 },
            "audio_tokens": { "type": "integer", "minimum": 0 }
          },
          "additionalProperties": false
        }
      },
      "additionalProperties": false
    }
  },
  
  "type": "object",
  "properties": {
    "schema_version": { "const": "1.0.1" },
    "id": { 
      "type": "string",
      "minLength": 1
    },
    "model": { 
      "type": "string",
      "minLength": 1
    },
    "created": { 
      "type": "integer", 
      "minimum": 0 
    },
    "choices": {
      "type": "array",
      "items": { "$ref": "#/definitions/choice" },
      "minItems": 1
    },
    "candidates": {
      "type": "array",
      "items": { "$ref": "#/definitions/choice" }
    },
    "usage": { "$ref": "#/definitions/usage" },
    "system_fingerprint": { "type": "string" },
    "service_tier_utilized": {
      "enum": ["default", "scale", "auto", "flex", "priority"]
    },
    "object": { "type": "string" },
    "type": { "type": "string" },
    "role": { "type": "string" },
    "stop_reason": {
      "enum": [
        "end_turn", "max_tokens", "stop_sequence", "tool_use", null
      ]
    },
    "stop_sequence": { "type": "string" },
    "provider": {
      "type": "string",
      "enum": ["openai", "anthropic", "gemini"]
    },
    "provider_raw": {
      "type": "object",
      "additionalProperties": true
    },
    "safety_feedback": {
      "type": "array",
      "items": {
        "type": "object",
        "properties": {
          "category": {
            "enum": [
              "HARM_CATEGORY_HARASSMENT",
              "HARM_CATEGORY_HATE_SPEECH",
              "HARM_CATEGORY_SEXUALLY_EXPLICIT",
              "HARM_CATEGORY_DANGEROUS_CONTENT"
            ]
          },
          "probability": {
            "enum": ["NEGLIGIBLE", "LOW", "MEDIUM", "HIGH"]
          },
          "blocked": { "type": "boolean" }
        },
        "required": ["category", "probability"],
        "additionalProperties": false
      }
    },
    "metadata": {
      "type": "object",
      "properties": {
        "provider": { "type": "string" },
        "original_model": { "type": "string" },
        "processing_time": { "type": "number", "minimum": 0 }
      },
      "additionalProperties": true
    }
  },
  "required": ["schema_version", "id", "model", "created", "choices"],
  "additionalProperties": false
}